-- Amy Hong, May 2019
-- This script generates a table with 4 columns for q_uuid, patient_id, diagnosis_date, and testing_date
-- for breast cancer patients who received HER2 testing

-- vw_cancer: condition_concept_canonical_code
-- -> for breast cancer, '372095001','372064008','254837009'

-- vw_sequencing: observation_concept_canonical_code
-- -> for HER2, 'HGNC:3430' (ERBB2)
-- -> for HR, 'HGNC:8910' (PGR), 'HGNC:3467' (ESR1), 'HGNC:3443' (EREG)

SET SEARCH_PATH = clinical_mart_v1_2;
DROP TABLE IF EXISTS #dx_date;
DROP TABLE IF EXISTS #prot_test;
CREATE TABLE #dx_date AS (
    SELECT DISTINCT q_uuid, patient_id, to_date(min(onset_date_time),'YYYY-MM-DD') AS diagnosis_date
    FROM clinical_mart_v1_2.vw_cancer
    /* ↓ insert appropriate condition codes in the parentheses to change cancer type ↓ */
    WHERE condition_concept_canonical_code IN ('372095001','372064008','254837009')
    /* ↓ insert primary/additional ↓ */
    AND clinical_status = 'additional'
    AND onset_date_time IS NOT NULL
    AND q_uuid IS NOT NULL
    AND patient_id IS NOT NULL
    GROUP BY q_uuid, patient_id
    HAVING diagnosis_date > '1000-01-01'
);
CREATE TABLE #prot_test AS (
    SELECT q_uuid, patient_id, to_date(sequencing_date,'YYYY-MM-DD') AS testing_date
    FROM clinical_mart_v1_2.vw_sequencing
    /* ↓ insert appropriate observation codes in the parentheses to change protein type ↓ */
    WHERE observation_concept_canonical_code IN ('HGNC:8910','HGNC:3467','HGNC:3443')
    AND sequencing_date IS NOT NULL
    AND q_uuid IS NOT NULL
    AND patient_id IS NOT NULL
    GROUP BY q_uuid, patient_id, sequencing_date
    HAVING testing_date > '1000-01-01'
);
SELECT #dx_date.q_uuid, #dx_date.patient_id, #dx_date.diagnosis_date, #prot_test.testing_date FROM #dx_date --3379
JOIN #prot_test
ON #dx_date.q_uuid = #prot_test.q_uuid
GROUP BY #dx_date.q_uuid, #dx_date.patient_id, #dx_date.diagnosis_date, #prot_test.testing_date
ORDER BY #dx_date.q_uuid, #prot_test.testing_date;
